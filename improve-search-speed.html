<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia at 2016-01-06 
 | Rendered using Apache Maven Fluido Skin 1.4
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20160106" />
    <meta http-equiv="Content-Language" content="en" />
    <title>BlackLab &#x2013; Improving Search Speed</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.4.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />

      
    <script type="text/javascript" src="./js/apache-maven-fluido-1.4.min.js"></script>

                          
        
<link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Nunito:300"/>
          
                  </head>
        <body class="topBarDisabled">
          
                
                    
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                <div id="bannerLeft">
                                                                                                <img src="images/logo-blacklab.png"  alt="BlackLab"/>
                </div>
                      </div>
        <div class="pull-right">                  <a href="http://www.inl.nl/" id="bannerRight">
                                                                                                <img src="images/logo-inl.png"  alt="INL"/>
                </a>
      </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
                
                    
                              <li class="">
                    <a href="http://www.inl.nl/" class="externalLink" title="INL">
        INL</a>
                    <span class="divider">/</span>
      </li>
            <li class="">
                    <a href="index.html" title="BlackLab">
        BlackLab</a>
                    <span class="divider">/</span>
      </li>
        <li class="active ">Improving Search Speed</li>
        
                
                    
                  <li id="publishDate" class="pull-right"><span class="divider">|</span> Last Published: 2016-01-06</li>
              <li id="projectVersion" class="pull-right">
                    Version: 1.3-SNAPSHOT
        </li>
            
                            </ul>
      </div>

            
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
                
                    
                <ul class="nav nav-list">
                    <li class="nav-header">BlackLab</li>
                              
      <li>
  
                          <a href="index.html" title="Introduction">
          <span class="none"></span>
        Introduction</a>
            </li>
                                                                                                                                                                
      <li>
  
                          <a href="learn.html" title="Learn">
          <span class="icon-chevron-down"></span>
        Learn</a>
                    <ul class="nav nav-list">
                    
      <li>
  
                          <a href="getting-started.html" title="Getting Started">
          <span class="none"></span>
        Getting Started</a>
            </li>
                    
      <li>
  
                          <a href="corpus-query-language.html" title="Corpus Query Language">
          <span class="none"></span>
        Corpus Query Language</a>
            </li>
                    
      <li>
  
                          <a href="example-application.html" title="The Example Application">
          <span class="none"></span>
        The Example Application</a>
            </li>
                    
      <li>
  
                          <a href="add-input-format.html" title="Add An Input Format">
          <span class="none"></span>
        Add An Input Format</a>
            </li>
                    
      <li class="active">
  
            <a href="#"><span class="none"></span>Improve Search Speed</a>
          </li>
                    
      <li>
  
                          <a href="apidocs/index.html" title="API reference">
          <span class="none"></span>
        API reference</a>
            </li>
              </ul>
        </li>
                
      <li>
  
                          <a href="downloads.html" title="Downloads">
          <span class="none"></span>
        Downloads</a>
            </li>
                
      <li>
  
                          <a href="faq.html" title="FAQ">
          <span class="none"></span>
        FAQ</a>
            </li>
                
      <li>
  
                          <a href="changelog.html" title="Change Log">
          <span class="none"></span>
        Change Log</a>
            </li>
                
      <li>
  
                          <a href="roadmap.html" title="Road Map">
          <span class="none"></span>
        Road Map</a>
            </li>
                              <li class="nav-header">Project Documentation</li>
                                                                                                                                                                                                                                
      <li>
  
                          <a href="project-info.html" title="Project Information">
          <span class="icon-chevron-right"></span>
        Project Information</a>
                  </li>
                                                                                                                                                                                                                                                      
      <li>
  
                          <a href="project-reports.html" title="Project Reports">
          <span class="icon-chevron-right"></span>
        Project Reports</a>
                  </li>
            </ul>
                
                    
                
          <hr />

           <div id="poweredBy">
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
                  </div>
          </div>
        </div>
        
                
        <div id="bodyColumn"  class="span10" >
                                  
            <h1>Improving Search Speed</h1>
<p>At INL, we use a tool called <a class="externalLink" href="http://hoytech.com/vmtouch/">vmtouch</a> written by Doug Hoyte to &#x2018;lock&#x2019; our forward indices in the operating system&#x2019;s disk cache, keeping them in memory at all times. This speeds up sorting and grouping operations, as well as generating (large amounts of) KWICs (keyword-in-context results).</p>
<p>vmtouch is a tool that can &#x201c;lock&#x201d; a file in disk cache. It benefits applications that need to perform fast random access to large files (i.e. several gigabytes). Corpus search applications fall into this domain: they need random access to the &#x201c;forward index&#x201d; component of the index to do fast sorting and grouping.</p>
<p>You should be careful to ensure the machine you&#x2019;re using has enough RAM to keep the required files in memory permanently, and will still have memory left over for the operating system and applications.</p>
<p>Also important is to run vmtouch as the root user; user accounts have a limit to the amount of memory they may lock. Vmtouch will terminate with an out of memory error if it hits that limit. (it may be possible to raise this limit for a user by changing a configuration file - we haven&#x2019;t experimented with this)</p>
<p>The <a class="externalLink" href="http://hoytech.com/vmtouch/">official page for vmtouch</a> has the C source code and the online manual. We&#x2019;ve made a slight modification to the source code to allow for larger files to be cached. The full source code of the version we&#x2019;re using is included in the vmtouch/ directory of the BlackLab source distribution.</p>
<div class="section">
<h2><a name="Building_vmtouch"></a>Building vmtouch</h2>
<p>The BlackLab source distribution includes a vmtouch/ directory with the source code for vmtouch, modified to increase the limit to 6 GB per file.</p>
<p><b>NOTE</b>: <a class="externalLink" href="http://hoytech.com/vmtouch/">Doug Hoyte</a> wrote and holds the copyright for the vmtouch code. He has released it under a permissive license (see vmtouch.c for the complete license text).</p>
<p>To build it using gcc and GNU Make, just type:</p>

<div class="source">
<div class="source"><pre class="prettyprint">make
</pre></div></div>
<div class="section">
<h3><a name="Filesize_limit"></a>Filesize limit</h3>
<p>The original vmtouch has a built-in 500 MB per file limit (probably as a safety precaution). We needed to raise this limit to allow for our 2GB+ files. Hence this line:</p>

<div class="source">
<div class="source"><pre class="prettyprint">size_t o_max_file_size=500*1024*1024;
</pre></div></div>
<p>was changed to:</p>

<div class="source">
<div class="source"><pre class="prettyprint">size_t o_max_file_size=6L*1024*1024*1024;
</pre></div></div>
<p>(Please note that if you wish to cache files larger than 6 GB, you will need to change this line again)</p></div></div>
<div class="section">
<h2><a name="Running_vmtouch"></a>Running vmtouch</h2>
<p>To run vmtouch in daemon mode, so that it will lock files in the disk cache, use the following command line:</p>

<div class="source">
<div class="source"><pre class="prettyprint">sudo vmtouch -vtld &lt;list_of_files&gt;
</pre></div></div>
<p>The switches: v=verbose, t=touch (load into disk cache), l=lock (lock in disk cache), d=daemon (keep the program running). For example, we use the following command line to keep all four forward indices of our BlackLab index locked in disk cache (run from within the index directory):</p>

<div class="source">
<div class="source"><pre class="prettyprint">sudo vmtouch -vtld fi_contents%word/tokens.dat fi_contents%lemma/tokens.dat fi_contents%pos/tokens.dat fi_contents%punct/tokens.dat
</pre></div></div>
<p>The daemon will start up and will take a while to load all files into disk cache. You can check its progress by only specifying the -v option:</p>

<div class="source">
<div class="source"><pre class="prettyprint">sudo vmtouch -v fi_contents%word/tokens.dat fi_contents%lemma/tokens.dat fi_contents%pos/tokens.dat fi_contents%punct/tokens.dat
</pre></div></div></div>
<div class="section">
<h2><a name="Helper_scripts"></a>Helper scripts</h2>
<p>We have written a few simple helper scripts for using vmtouch. These scripts are included in the vmtouch/script/ directory of the BlackLab source distribution, but they are reproduced here for convenience.</p>
<p>The first shell script activates the vmtouch daemon for a number of corpora under the same base directory. The second shell script checks the cache status for these files. The third is an init script you can place in /etc/init.d (under Debian) to (automatically) start/stop the daemon on a server.</p>
<div class="section">
<h3><a name="activateVmtouch.sh"></a>activateVmtouch.sh</h3>

<div class="source">
<div class="source"><pre class="prettyprint">#!/bin/bash
# This script will read specific large files in BlackLab indices into the
# disk cache and lock them there. This improves performance for
# applications needing random access on those files.

if [ &quot;$EUID&quot; -ne 0 ]
then
  echo &quot;Please run as root&quot;
  exit
fi

DATASETS_DIR=/blacklab/indices
VMTOUCH_BINARY=/blacklab/bin/vmtouch/vmtouch

# Figure out the list of files to cache
cd $DATASETS_DIR
FILES_TO_CACHE=
for DATASET in `ls $DATASETS_DIR`
do
  if [ -d $DATASET ]; then
    echo &quot;  $DATASET&quot;
    FILES_TO_CACHE=&quot;$FILES_TO_CACHE $DATASET/fi_contents%word/tokens.dat $DATASET/fi_contents%lemma/tokens.dat $DATASET/fi_contents%pos/tokens.dat $DATASET/fi_contents%punct/tokens.dat&quot;
  fi
done

# Start vmtouch daemon to keep files in disk cache
$VMTOUCH_BINARY -vtld $FILES_TO_CACHE
</pre></div></div></div>
<div class="section">
<h3><a name="checkCache.sh"></a>checkCache.sh</h3>

<div class="source">
<div class="source"><pre class="prettyprint">#!/bin/sh
# This script checks to see how much of the set of files to cache
# is currently in the disk cache. Should eventually reach and stay
# at 100%.

DATASETS_DIR=/blacklab/indices
VMTOUCH_BINARY=/blacklab/bin/vmtouch/vmtouch

# Figure out the list of files to cache
cd $DATASETS_DIR
FILES_TO_CACHE=
for DATASET in `ls $DATASETS_DIR`
do
  if [ -d $DATASET ]; then
    FILES_TO_CACHE=&quot;$FILES_TO_CACHE $DATASET/fi_contents%word/tokens.dat $DATASET/fi_contents%lemma/tokens.dat $DATASET/fi_contents%pos/tokens.dat $DATASET/fi_contents%punct/tokens.dat&quot;
  fi
done

# Check to see how much of the files has been cached
$VMTOUCH_BINARY -v $FILES_TO_CACHE
</pre></div></div></div>
<div class="section">
<h3><a name="aetcinit.dvmtouch_startupscript"></a>/etc/init.d/vmtouch (startupscript)</h3>

<div class="source">
<div class="source"><pre class="prettyprint">#!/bin/sh
### BEGIN INIT INFO
# Provides:          vmtouch
# Required-Start:    $remote_fs $syslog
# Required-Stop:     $remote_fs $syslog
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: Start vmtouch at boot time
# Description:       Keeps certain files locked in the disk cache.
### END INIT INFO

# (Adapted from template at https://github.com/fhd/init-script-template/)

# Settings: dir to run from, user to run under, command to run
dir=&quot;/blacklab/bin/vmtouch&quot;
user=&quot;root&quot;
cmd=&quot;/blacklab/bin/vmtouch/activateVmtouch.sh&quot;

# Daemon's name
name=`basename $0`

# Log files
stdout_log=&quot;/var/log/$name.log&quot;
stderr_log=&quot;/var/log/$name.err&quot;

# If vmtouch is running, return its PID.
get_pid() {
    echo `ps -ef | grep -v grep | grep &quot;vmtouch -vtld&quot; | awk '{print $2}' `
}

# Check to see if vmtouch is running.
is_running() {
    ps -ef | grep -v grep | grep &quot;vmtouch -vtld&quot; &gt;/dev/null
}

# Start, stop, restart or show status of vmtouch, depending on commandline
case &quot;$1&quot; in
    start)
    if is_running; then
        echo &quot;Already started&quot;
    else
        echo &quot;Starting $name&quot;
        cd &quot;$dir&quot;
        sudo -u &quot;$user&quot; $cmd &gt;&gt; &quot;$stdout_log&quot; 2&gt;&gt; &quot;$stderr_log&quot;
        if ! is_running; then
            echo &quot;Unable to start, see $stdout_log and $stderr_log&quot;
            exit 1
        fi
    fi
    ;;
    stop)
    if is_running; then
        echo -n &quot;Stopping $name..&quot;
        kill `get_pid`
        for i in {1..10}
        do
            if ! is_running; then
                break
            fi

            echo -n &quot;.&quot;
            sleep 1
        done
        echo

        if is_running; then
            echo &quot;Not stopped; may still be shutting down or shutdown may have failed&quot;
            exit 1
        else
            echo &quot;Stopped&quot;
        fi
    else
        echo &quot;Not running&quot;
    fi
    ;;
    restart)
    $0 stop
    if is_running; then
        echo &quot;Unable to stop, will not attempt to start&quot;
        exit 1
    fi
    $0 start
    ;;
    status)
    if is_running; then
        echo &quot;Running&quot;
    else
        echo &quot;Stopped&quot;
        exit 1
    fi
    ;;
    *)
    echo &quot;Usage: $0 {start|stop|restart|status}&quot;
    exit 1
    ;;
esac

exit 0
</pre></div></div></div></div>
                  </div>
            </div>
          </div>

    <hr/>

    <footer>
            <div class="container-fluid">
                      <div class="row-fluid">
                                      <p >Copyright &copy;                    2016
                        <a href="http://www.inl.nl">INL</a>.
            All rights reserved.      
                    
      </p>
                </div>

        
                </div>
    </footer>
        </body>
</html>
